# 币安账户信息接口开发记录

## 用户需求

在 `/Users/peng/Desktop/Project/0-ppll/ppll-server/route/v1/binance-account.route.js` 中编写3个接口，实现功能：

1. 获得U本位合约账户信息
2. 获得现货账户信息
3. 获得币本位合约账户信息

开放模式需要参考 `/Users/peng/Desktop/Project/0-ppll/ppll-server/route/v1/template.route.js` 实行 MVC 架构。

## 实现方案

### 技术架构

- **架构模式**: MVC (Model-View-Controller)
- **框架**: Express.js
- **数据库**: 不需要，直接调用币安API
- **API文档**: Swagger/OpenAPI 3.0
- **权限控制**: VIP权限验证

### 开发过程中发现的问题

#### 1. API端点配置问题

- **问题**: 不同类型的币安账户使用不同的API端点
- **解决方案**:
    - 现货账户: `https://api.binance.com/api/v3/account`
    - U本位合约: `https://fapi.binance.com/fapi/v2/account`
    - 币本位合约: `https://dapi.binance.com/dapi/v1/account`

#### 2. 客户端配置差异

- **问题**: 不同类型账户需要不同的客户端实例
- **解决方案**: 创建专门的客户端创建函数
    - `createSpotClient()`: 现货客户端 (MainClient)
    - `createUSDMClient()`: U本位合约客户端 (USDMClient)
    - `createCoinMClient()`: 币本位合约客户端 (CoinMClient)

#### 3. 错误处理和备用方案

- **问题**: 官方SDK可能调用失败，需要备用方案
- **解决方案**: 实现双层错误处理机制
    - 优先使用官方SDK调用
    - SDK失败时切换到自定义request调用
    - 统一错误处理和日志记录

#### 4. 代理配置

- **问题**: 开发环境需要代理，生产环境不需要
- **解决方案**: 根据 `process.env.NODE_ENV` 动态配置代理

### 使用的解决方案

#### 1. 服务层设计 (`service/binance-account.service.js`)

```javascript
// 核心功能函数
- getUSDMFuturesAccount(): 获取U本位合约账户信息
- getSpotAccount(): 获取现货账户信息
- getCoinMFuturesAccount(): 获取币本位合约账户信息

// 客户端创建函数
- createSpotClient(): 创建现货客户端
- createUSDMClient(): 创建U本位合约客户端
- createCoinMClient(): 创建币本位合约客户端
```

#### 2. 控制器层设计 (`controller/binance-account.controller.js`)

```javascript
// 请求处理函数
- getUSDMFuturesAccount(): 处理U本位合约账户请求
- getSpotAccount(): 处理现货账户请求
- getCoinMFuturesAccount(): 处理币本位合约账户请求

// 工具函数
- extractApiCredentials(): 提取API凭证
- handleError(): 通用错误处理
- res.apiSuccess(): 通用成功响应
```

#### 3. 路由层设计 (`route/v1/binance-account.route.js`)

```javascript
// API端点定义
- GET /v1/binance-account/usdm-futures: U本位合约账户信息
- GET /v1/binance-account/spot: 现货账户信息
- GET /v1/binance-account/coinm-futures: 币本位合约账户信息
```

### API接口详细说明

#### 1. U本位合约账户信息

- **端点**: `GET /v1/binance-account/usdm-futures`
- **参数**:
    - `apiKey`, `apiSecret` (必需)
    - `includePositions` (可选): 是否包含持仓信息，默认true。设置为false可以显著减少内存占用和响应数据大小
- **权限**: VIP用户
- **返回数据**:
    - 账户基本信息 (手续费等级、交易权限等)
    - 资金信息 (总余额、可用余额、未实现盈亏等)
    - 持仓详情 (各交易对持仓数量、盈亏、强平价格等 - 可选)
    - 保证金信息 (初始保证金、维持保证金等)

#### 2. 现货账户信息

- **端点**: `GET /v1/binance-account/spot`
- **参数**:
    - `apiKey`, `apiSecret` (必需)
    - `includeEmptyBalances` (可选): 是否包含空余额币种，默认true。设置为false只返回有余额的币种，可以显著减少内存占用
- **权限**: VIP用户
- **返回数据**:
    - 账户基本信息 (手续费等级、交易权限、账户类型等)
    - 资产余额 (各币种可用余额和冻结余额 - 可过滤空余额币种)
    - 权限信息 (支持的操作权限)

#### 3. 币本位合约账户信息

- **端点**: `GET /v1/binance-account/coinm-futures`
- **参数**:
    - `apiKey`, `apiSecret` (必需)
    - `includePositions` (可选): 是否包含持仓信息，默认true。设置为false可以显著减少内存占用和响应数据大小
- **权限**: VIP用户
- **返回数据**: 类似U本位合约账户，但使用币本位合约数据（持仓信息可选）

### 将来如何维护

#### 1. 代码维护

- **文件结构**: 清晰的MVC分层，便于维护和扩展
- **错误处理**: 统一的错误处理机制，便于问题定位
- **日志记录**: 详细的控制台日志，便于调试

#### 2. API维护

- **版本兼容**: 使用官方SDK，自动兼容币安API变更
- **备用方案**: 当SDK失效时自动切换到REST API调用
- **权限控制**: 通过VIP中间件控制访问权限

#### 3. 测试维护

- **测试文件**: `test/test-binance-account.js` 提供完整的接口测试
- **用例覆盖**: 包括正常测试、错误处理、权限验证等
- **配置灵活**: 支持环境变量配置API凭证

#### 4. 文档维护

- **API文档**: 完整的Swagger文档，支持在线测试
- **代码注释**: 详细的中文注释，便于理解
- **使用示例**: 测试文件包含完整的使用示例

### 部署注意事项

1. **环境变量**: 生产环境需要配置正确的 `NODE_ENV`
2. **代理设置**: 生产环境会自动禁用代理配置
3. **权限配置**: 确保VIP中间件正常工作
4. **API限制**: 注意币安API的速率限制

### 测试方法

```bash
# 设置环境变量
export BINANCE_API_KEY="your_api_key"
export BINANCE_API_SECRET="your_api_secret"

# 运行测试
node test/test-binance-account.js
```

### 文件清单

- `service/binance-account.service.js` - 业务逻辑层
- `controller/binance-account.controller.js` - 控制器层
- `route/v1/binance-account.route.js` - 路由层
- `test/test-binance-account.js` - 测试文件
- `docs/币安账户信息接口开发记录.md` - 开发记录文档

本次开发严格按照项目的MVC架构规范，实现了完整的币安账户信息查询功能，包含错误处理、权限验证、API文档等完整的开发要素。

### 杠杆倍数本地缓存方案（每日更新）

- **背景**: 杠杆上限数据短期内稳定且变动不频繁，反复请求会浪费配额与时间。
- **方案**: 将当日查询到的每个交易对最大杠杆倍数本地缓存到 JSON 文件，次日自动切换新文件。
- **存储路径**: `datum/binance/um/leverage/YYYY-MM-DD.json`
- **数据结构**: 简单KV映射
    ```json
    {
        "BTCUSDT": 125,
        "ETHUSDT": 100
    }
    ```
- **读写逻辑**:
    - 读取时优先查找当日文件；命中则直接返回对应 `symbol` 的倍数；
    - 未命中则调用 Binance 接口获取该 `symbol` 的最大杠杆，并将结果“合并写回”当日文件；
    - 写入失败不影响主流程（仅记录警告日志）。
- **接入位置**: `service/binance-account.service.js` 中 `getMaxLeverage(client, symbol)`。
- **维护要点**:
    - 目录不存在时自动创建；
    - 日期按服务器本地时间生成 `YYYY-MM-DD`；
    - 当 API 响应结构发生变化时，保持对数组/对象两种返回形态的兼容解析；
    - 若解析失败或接口异常，函数返回 `null`，不阻塞上游业务。

#### 公共工具复用

- **通用函数文件**: `utils/file.js`
- **复用方法**:
    - `ensureDir(dir)`: 确保目录存在（幂等）
    - `readJsonSafe(filePath, defaultObject)`: 安全读取 JSON 文件
    - `writeJsonSafe(filePath, data)`: 安全写入 JSON 文件
- **使用位置**: `service/binance-account.service.js` 的缓存读写逻辑改为调用上述通用函数，避免重复实现与维护。
