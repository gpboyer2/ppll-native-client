# 用户状态验证逻辑修复项目

## 背景

前端请求用户查询接口 `/v1/user/query` 时，返回错误信息"账户已被禁用"，但数据库中该用户的status为2（启用状态）。

## 问题分析

### 发现的问题

1. **状态枚举值不一致**
   - 数据库用户模型定义：status=1（未知）, status=2（启用）, status=3（禁用）
   - 认证服务中的验证逻辑期望：status=1 为启用状态

2. **认证中间件状态验证被注释**
   - `middleware/auth.js` 第17-19行状态验证逻辑被注释掉
   - JWT验证通过后没有检查用户状态

### 涉及的文件

- `models/user.js:78-83` - 用户状态字段定义
- `service/auth.service.js:36,98` - 登录时状态验证（期望status=1，需修复为status=2）
- `middleware/auth.js:17-19` - API调用时状态验证（被注释，需启用）
- `route/v1/user.route.js:392` - 用户查询路由配置

### 查询筛选逻辑（无需修改）

- `service/user.service.js:221` - 查询筛选逻辑：`!== 1` 表示排除未知状态筛选
- `controller/user.controller.js:78` - 查询筛选逻辑：`!== 1` 表示排除未知状态筛选

说明：查询接口的筛选逻辑是正确的，当status=1时不进行状态筛选（显示所有状态），当status=2或3时按具体状态筛选。

## 解决方案

### 修复步骤

1. **修复认证服务中的状态验证逻辑**
   - 文件：`service/auth.service.js`
   - 修改：将 `user.status !== 1` 改为 `user.status !== 2`
   - 位置：第36、98行（登录验证）

2. **启用认证中间件的状态验证**
   - 文件：`middleware/auth.js`
   - 修改：取消注释状态验证逻辑
   - 确保验证逻辑为 `user.status !== 2`

3. **移除重复的状态验证**
   - 文件：`service/auth.service.js`
   - 修改：移除 `getUserProfile` 函数中的重复状态验证
   - 原因：该函数调用前已通过auth中间件验证

### 修复结果

- 登录验证时正确检查用户状态（status=2为启用）
- API调用时正确检查用户状态（status=2为启用）
- 状态为禁用（status=3）或未知（status=1）的用户无法通过认证

## 验证步骤

1. 确认数据库中用户status=2（启用状态）
2. 使用该用户的JWT token调用 `/v1/user/query` 接口
3. 应该返回正确的用户列表数据，而不是"账户已被禁用"错误

## 维护方式

### 状态枚举定义
- status=1：未知状态（不可用）
- status=2：启用状态（可正常使用）
- status=3：禁用状态（不可用）

### 注意事项
- 修改用户状态时确保使用正确的枚举值
- 新增状态验证逻辑时保持一致性
- 避免重复验证：登录时验证，API调用时通过中间件统一验证
- 中间件验证确保了动态状态变更的安全性

### 验证层级
1. **登录时验证**：`auth.service.js` 中的登录函数
2. **API调用验证**：`middleware/auth.js` 统一处理
3. **避免重复**：业务函数中无需再次验证用户状态

### 相关接口
- POST `/v1/auth/admin/login` - 管理员登录验证
- POST `/v1/auth/app/login` - APP端登录验证  
- GET `/v1/auth/user/profile` - 用户信息（通过中间件验证）
- GET `/v1/user/query` - 用户查询接口（通过中间件验证）
- 所有需要JWT认证的API接口
