Binance 网格交易系统设计方案

### 1. 需求与约束确认

系统需满足集成性、多市场支持、持久化与恢复、智能连接复用、API驱动以及逻辑隔离等关键约束。

集成性: 新功能必须无缝融入现有的 Node.js/Express 项目架构中（遵循 `controller`, `service`, `model` 等分层模式）。
核心交易库: 明确使用 `npm binance` 库作为与 Binance API 交互的唯一工具。
多市场支持: 系统需要同时处理现货（Spot）、U本位合约（UM）和币本位合约（CM）的网格策略。
持久化与恢复: 所有正在运行的网格策略状态必须存储在数据库中，以便在应用重启后能自动加载并恢复运行。
连接复用: 这是关键性能要求。所有针对同一产品类型和同一交易对（例如，所有 `UM_ARUSDT` 的策略）的策略，必须共享同一个 WebSocket 连接，以避免资源浪费和达到交易所的连接数限制。
API驱动: 系统的所有操作（创建、查询、更新、删除策略）都必须通过一套 RESTful API 来完成，供外部客户端调用。
逻辑隔离:
  - 严格禁止为每个用户或每个策略创建独立的 WebSocket 连接。
  - 现货和合约的订单处理逻辑必须分开，不能混用，因为它们的下单参数和行为不同。


### 2. 模块关系图 (Mermaid)

见 `/Users/peng/Desktop/Project/ppll/ppll-server/docs/需求设计/网格交易系统/网格交易系统.md`

### 3. 具体实现方案
接下来，我将提供详细的实现步骤和代码结构设计。

#### 3.1. 数据模型 (Model)

为了实现策略持久化，我们需要在数据库中创建一个 `GridStrategy` 模型。

文件路径: `models/grid-strategy.js`

#### 3.2. 核心服务 (Services & Plugins)

这是系统的大脑，包含最关键的逻辑。

##### a. `WebSocketConnectionManager` (单例)

这是实现“智能连接复用”的核心。它将作为一个单例服务，全局管理所有 WebSocket 连接。

职责: 智能管理 WebSocket 连接池，实现按需创建、自动复用和自动销毁。
设计: 保持原设计不变。它作为被动服务，由 `GridStrategyService` 驱动，是实现连接复用的基石。

文件路径: `service/ws-connection-manager.js`

##### b. `OrderHandler` (按产品类型拆分)

职责: 封装不同产品类型（现货、U本位、币本位）的下单、撤单等具体操作。这是新设计中的一个关键改进，确保了逻辑的清晰和隔离。

建议实现: 使用工厂模式或分别导出。

文件路径: `plugin/order-handler/index.js`

每个具体的 handler (e.g., `spot.handler.js`) 将包含使用 `Binance REST Client` 的实际下单逻辑。

##### c. `InfiniteGrid (StrategyExecutor)`

职责: 核心策略执行引擎。监听价格变动，根据网格参数判断交易时机，并调用相应的 `OrderHandler` 执行交易。

负责执行单个网格策略的逻辑。它会被 `GridStrategyService` 实例化，并监听由 `WebSocketConnectionManager` 提供的 WebSocket 数据流。

文件路径: `/Users/peng/Desktop/Project/0-ppll/ppll-server/plugin/umInfiniteGrid.js`


##### d. `GridStrategyService`

职责: 系统的总指挥。它连接上层 `Controller` 和下层的 `WebSocketConnectionManager` 与 `StrategyExecutor`，负责策略的完整生命周期管理（创建、启动、停止、更新、删除）和恢复。

文件路径: `service/grid-strategy.service.js`


##### e. 策略恢复入口

职责: 在应用启动时，调用 `GridStrategyService` 的恢复流程。

文件路径: `app.js` (项目主入口文件)


#### 3.3. API 接口 (Controller & Routes)

创建面向外部的 REST API。

文件路径: `controller/grid-strategy.controller.js` 和 `route/v1/grid-strategy.route.js`
将新路由注册到 `route/route.manager.js` 中。
