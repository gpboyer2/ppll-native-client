# 用户更新接口安全测试报告

## 文档概述（不允许修改这部分内容）

本文档记录针对User和Auth等接口的安全测试过程，使用真实API接口进行测试、发现安全漏洞后通过修改业务代码以实施紧急修复。

## 参考的接口文档（不允许修改这部分内容）
- /Users/peng/Desktop/Project/ppll/ppll-admin/docs/api/auth.json
- /Users/peng/Desktop/Project/ppll/ppll-admin/docs/api/user.json

## 核心需求（不允许修改这部分内容）

### 测试要求
- 不要使用任何测试框架，用户的目的是直接使用node执行js文件就可以进行测试
- 只准修改文件 `/Users/peng/Desktop/Project/ppll/ppll-server/test/test_api_security.js` 进行测试
- 不新增文件，保持单测文件内完成所有安全场景覆盖

### 基础安全原则
- 只有管理员能登录后台
- 只有管理员能修改用户信息
- 有些接口只有特定权限的用户能调用（通过中间件来判断`auth(['admin', 'super_admin'])`）
- 通过取 Authorization、authorized-token、expires来判断调用接口的人是否是管理员，以及登录状态是否过期

### 详细安全测试要求

#### 权限限定
- 普通用户修改自己的任何字段 → 401（禁止）
- 普通用户查看自己信息和数据 → 200（允许）
- 普通用户查看其他用户的任何信息和数据 → 401（禁止）

#### 权限升降级
- admin 把其他用户提升为 super_admin 或者 admin → 应被拒绝（403）
- admin 把自己降为普通用户 → 应被拒绝（防止锁死后台）
- admin 将其他 admin 降为普通用户 → 应被拒绝（403）
- admin 尝试修改自己的任何字段（无论改为什么值）→ 403（禁止）
- super_admin 把其他用户提升为 super_admin → 应被拒绝（403）
- super_admin 把自己降为普通用户 → 应被拒绝（防止锁死后台）
- super_admin 将普通用户提升为 admin → 200（允许）
- super_admin 将其他 admin 降为普通用户 → 200（允许）
- super_admin 尝试修改自己的 role（无论改为什么值）→ 403（禁止）

#### 横向越权
- 普通用户 A 拿 A 的 token 去改 B 的 apiKey/apiSecret → 应 403
- 普通用户 A 拿 admin 的 token 去改 B 的 apiKey/apiSecret → 应 403
- 普通用户 A 拿 super_admin 的 token 去改 B 的 apiKey/apiSecret → 应 403
- admin 改 A 的敏感字段 apiKey/apiSecret→ 不允许
- admin 改 A 的敏感字段 role，为普通用户提权→ 不允许
- admin 改 A 的敏感字段（vip过期时间、username）→ 成功并写审计日志
- admin 尝试修改 super_admin 的任何信息 → 403（禁止）

#### Token 刷新边界
- expires 剩 1 秒时并发 2 次改密请求 → 第 1 次成功，第 2 次应 401（已过期）
- 刷新 token 后旧 token 应立刻失效（测返回 401）

#### Token 异常场景
- 使用过期 token 调用接口 → 401（未授权）
- 使用伪造 token 调用接口 → 401（未授权）
- 缺少 Authorization 头调用接口 → 401（未授权）
- 修改不存在的用户 ID → 404（用户不存在）
- 提交非法 role 值（如 role="ghost"）→ 400（参数错误）

#### 授权头缺失/错格式
- 无 Authorization → 401
- Bearer 对应的字段不存在或者不匹配 → 401
- token 对应的字段不存在或者不匹配 → 401

#### 超级管理员隔离
- admin 列表接口应不返回 super_admin 记录（测返回数组 .every(role !== 'super_admin')）
- admin 用户无法 增加/查看/编辑/删除 super_admin 用户

#### 审计与幂等
- 同一 admin 对同一用户 10 秒内重复提交相同字段 → 应幂等（返回 200，内容不变）
- 每次成功修改后响应头携带 X-Operation-Id（或写入响应体 auditId）方便追踪

#### 速率限制
- 连续 3 次错误 token 请求 → 应触发 429（或网关层返回 429，测试里 mock 即可）

#### 逻辑删除
- 只允许逻辑删除，不允许物理删除
- 删除用户后再次查询列表 → 应不再出现（或标记 deletedAt 不为空）
- 被删用户 token 立即失效（测 401）

### 前端接口示例
```bash
curl 'http://localhost:8848/v1/user/update' \
  -H 'Accept: application/json, text/plain, */*' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...' \
  -H 'Content-Type: application/json' \
  -b 'authorized-token={%22accessToken%22:%22...%22%2C%22expires%22:1758011714833}' \
  --data-raw '{"id":84,"role":"user","vip_expire":"2028-08-11T22:38:52.000Z"}'
```
