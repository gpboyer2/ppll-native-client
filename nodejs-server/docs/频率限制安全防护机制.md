# 频率限制安全防护机制

## 概述

本功能实现了一个基于滑动窗口的频率限制和IP封禁机制，用于防止API滥用、恶意爬虫、暴力破解和DDoS攻击。

## 核心功能

### 1. 频率检测
- **时间窗口**: 1分钟（60秒）
- **最大请求数**: 100次
- **检测方式**: 滑动窗口机制，精确统计最近60秒内的请求次数

### 2. 自动封禁
- **触发条件**: 同一IP在1分钟内发起超过100次请求
- **封禁时长**: 24小时（1天）
- **封禁效果**: 在封禁期间，来自该IP的所有API请求都被拒绝，返回429状态码

### 3. 智能识别
- **IP获取**: 支持多种IP获取方式，包括代理转发
- **本地IP跳过**: 自动跳过本地IP（127.0.0.1, ::1, localhost）
- **真实IP识别**: 优先使用 `x-forwarded-for` 和 `x-real-ip` 头部

## 技术实现

### 架构设计
```
请求 → IP识别 → 封禁检查 → 频率统计 → 封禁判断 → 响应
```

### 存储策略
- **内存存储**: 活跃IP的请求计数（高性能）
- **数据库存储**: 封禁记录（持久化）
- **自动清理**: 定期清理过期数据，避免内存泄漏

### 性能优化
- 使用内存Map存储请求计数，避免频繁数据库查询
- 滑动窗口算法，精确控制时间范围
- 定时清理任务，防止内存泄漏
- 错误处理机制，确保服务稳定性

## 配置参数

```javascript
const RATE_LIMIT = {
    WINDOW_MS: 60 * 1000,        // 时间窗口：1分钟
    MAX_REQUESTS: 100,           // 最大请求数：100次
    BAN_TIME_MS: 24 * 60 * 60 * 1000, // 封禁时长：24小时
    CLEANUP_INTERVAL_MS: 60 * 1000,   // 清理间隔：1分钟
};
```

## API接口

### 1. 获取IP封禁统计
```
GET /v1/analytics/ip-bans
```

**查询参数:**
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20）
- `status`: 封禁状态（0-已解除, 1-生效中）

**响应示例:**
```json
{
  "status": "success",
  "data": {
    "bannedIPs": [...],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 50,
      "totalPages": 3
    },
    "memoryStats": {...},
    "summary": {
      "totalBanned": 50,
      "activeBanned": 30,
      "memoryTracked": 25
    }
  }
}
```

### 2. 手动封禁IP
```
POST /v1/analytics/ip-bans
```

**请求体:**
```json
{
  "ip": "192.168.1.100",
  "reason": "恶意攻击",
  "remark": "管理员手动封禁",
  "duration": 24
}
```

### 3. 解除IP封禁
```
DELETE /v1/analytics/ip-bans/{ip}
```

### 4. 批量解除IP封禁
```
POST /v1/analytics/ip-bans/batch-unban
```

**请求体:**
```json
{
  "ips": ["192.168.1.100", "192.168.1.101"]
}
```

### 5. 清理过期封禁记录
```
POST /v1/analytics/ip-bans/cleanup
```

### 6. 获取IP封禁详情
```
GET /v1/analytics/ip-bans/{ip}
```

## 数据库表结构

### banned_ips 表
```sql
CREATE TABLE `banned_ips` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `ip` VARCHAR(45) NOT NULL COMMENT '被封禁的IP地址',
  `reason` VARCHAR(500) NOT NULL COMMENT '封禁原因',
  `banned_at` DATETIME NOT NULL COMMENT '封禁时间',
  `expires_at` DATETIME NOT NULL COMMENT '过期时间',
  `created_by` BIGINT NOT NULL DEFAULT 0 COMMENT '创建者用户ID',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态(0:已解除,1:生效中)',
  `remark` VARCHAR(255) COMMENT '备注',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_ip` (`ip`),
  KEY `idx_status` (`status`),
  KEY `idx_expires_at` (`expires_at`),
  KEY `idx_created_by` (`created_by`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='IP封禁记录表';
```

## 使用示例

### 1. 启动服务
```bash
npm start
```

### 2. 测试频率限制
```bash
# 快速发送请求测试频率限制
for i in {1..110}; do
  curl -X GET http://localhost:7002/v1/hello
  sleep 0.1
done
```

### 3. 查看封禁状态
```bash
curl -X GET http://localhost:7002/v1/analytics/ip-bans
```

### 4. 手动封禁IP
```bash
curl -X POST http://localhost:7002/v1/analytics/ip-bans \
  -H "Content-Type: application/json" \
  -d '{
    "ip": "192.168.1.100",
    "reason": "测试封禁",
    "remark": "手动测试"
  }'
```

## 监控和日志

### 控制台日志
- `[Rate Limit] IP {ip} 已被自动封禁24小时`
- `[Rate Limit] 清理了 {count} 个过期IP计数`
- `[Rate Limit] 清理了 {count} 条过期封禁记录`

### 错误处理
- 数据库连接失败时，默认不封禁IP
- 中间件异常时，继续处理请求
- 自动重试机制，确保服务稳定性

## 安全考虑

### 1. SQL注入防护
- 使用Sequelize ORM，避免原始SQL
- 参数化查询，防止注入攻击
- 输入验证和过滤

### 2. 性能保护
- 内存存储减少数据库压力
- 异步处理，不阻塞主线程
- 错误降级，确保服务可用

### 3. 配置安全
- 可配置的阈值参数
- 支持不同环境的配置
- 敏感信息加密存储

## 扩展功能

### 1. 白名单机制
可以添加IP白名单，跳过频率限制检查。

### 2. 动态配置
支持运行时修改频率限制参数。

### 3. 告警通知
当检测到攻击行为时，发送告警通知。

### 4. 统计分析
提供详细的攻击统计和分析报告。

## 故障排除

### 1. 内存使用过高
- 检查清理任务是否正常运行
- 调整清理间隔参数
- 监控内存使用情况

### 2. 误封正常用户
- 检查IP获取逻辑
- 调整频率限制阈值
- 添加白名单机制

### 3. 数据库连接问题
- 检查数据库连接配置
- 查看错误日志
- 确保数据库服务正常

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 实现基础频率限制功能
- 添加IP封禁管理接口
- 支持滑动窗口算法
- 集成数据库持久化存储 