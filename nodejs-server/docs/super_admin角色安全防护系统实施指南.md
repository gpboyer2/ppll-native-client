# Super Admin è§’è‰²å®‰å…¨é˜²æŠ¤ç³»ç»Ÿå®æ–½æŒ‡å—

## é—®é¢˜èƒŒæ™¯

åœ¨ç”¨æˆ·ç®¡ç†ç³»ç»Ÿä¸­ï¼Œsuper_admin æ˜¯æœ€é«˜æƒé™è§’è‰²ï¼Œå¿…é¡»ä¸¥æ ¼æ§åˆ¶å…¶åˆ›å»ºå’Œæå‡è¿‡ç¨‹ã€‚ä¸ºé˜²æ­¢å¼€å‘äººå‘˜æ„å¤–æˆ–æ¶æ„å°†æ™®é€šç”¨æˆ·æå‡ä¸º super_adminï¼Œéœ€è¦å»ºç«‹å¤šå±‚é˜²æŠ¤æœºåˆ¶ã€‚

## è§£å†³æ–¹æ¡ˆæ¦‚è¿°

æˆ‘ä»¬å®æ–½äº†å®Œæ•´çš„å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼š

### ğŸ›¡ï¸ æ ¸å¿ƒé˜²æŠ¤å±‚çº§

1. **æ•°æ®åº“å±‚é˜²æŠ¤** - ä½¿ç”¨ CHECK çº¦æŸå’Œè§¦å‘å™¨ä½œä¸ºæœ€åé˜²çº¿
2. **ä»£ç å±‚é˜²æŠ¤** - åœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ·»åŠ éªŒè¯  
3. **ä¸­é—´ä»¶é˜²æŠ¤** - ç»Ÿä¸€çš„è§’è‰²éªŒè¯ä¸­é—´ä»¶
4. **å®¡è®¡å±‚é˜²æŠ¤** - å®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•

### ğŸ”’ å®‰å…¨ç­–ç•¥
- **çº¯æ•°æ®åº“å±‚æ§åˆ¶** - å³ä½¿åº”ç”¨ä»£ç è¢«ç»•è¿‡ï¼Œæ•°æ®åº“å±‚é¢ä»èƒ½æä¾›ä¿æŠ¤
- **æˆæƒæœºåˆ¶** - åªæœ‰ç³»ç»Ÿç®¡ç†å‘˜é€šè¿‡ç‰¹å®šæˆæƒå˜é‡æ‰èƒ½æ“ä½œ
- **æ— æ³•ç»•è¿‡** - ä»»ä½•å½¢å¼çš„æ•°æ®åº“æ“ä½œéƒ½ä¼šè¢«æ‹¦æˆª

## å®æ–½æ­¥éª¤

### 1. æ•°æ®åº“å±‚é˜²æŠ¤éƒ¨ç½²ï¼ˆæ ¸å¿ƒï¼‰

æ‰§è¡Œæ•°æ®åº“å®‰å…¨é˜²æŠ¤è„šæœ¬ï¼š

```sql
-- è¿æ¥åˆ°æ•°æ®åº“
mysql -u your_username -p your_database

-- æ‰§è¡Œç”¨æˆ·è¡¨å®‰å…¨é˜²æŠ¤
source /path/to/ppll-database/ppll-server-users.sql

-- æ‰§è¡Œè§’è‰²è¡¨å®‰å…¨é˜²æŠ¤
source /path/to/ppll-database/ppll-server-roles.sql
```

#### ğŸ›¡ï¸ Usersè¡¨é˜²æŠ¤æœºåˆ¶ï¼š
- **CHECKçº¦æŸ**: é™åˆ¶ `role` å­—æ®µåªèƒ½ä¸º `user`, `admin`, `super_admin`, `operator`, `guest`
- **INSERTè§¦å‘å™¨**: é˜»æ­¢åˆ›å»º super_admin ç”¨æˆ·
- **UPDATEè§¦å‘å™¨**: é˜»æ­¢æå‡ç”¨æˆ·ä¸º super_adminï¼ŒåŒæ—¶ä¿æŠ¤ç°æœ‰ super_admin ä¸è¢«é™çº§

#### ğŸ›¡ï¸ Rolesè¡¨é˜²æŠ¤æœºåˆ¶ï¼š
- **UPDATEè§¦å‘å™¨**: é˜²æ­¢ä¿®æ”¹ã€ç¦ç”¨æˆ–è½¯åˆ é™¤ super_admin è§’è‰²
- **DELETEè§¦å‘å™¨**: é˜²æ­¢ç‰©ç†åˆ é™¤ super_admin è§’è‰²

#### ğŸ” æˆæƒå˜é‡ï¼š
- `@allow_super_admin_creation` - å…è®¸åˆ›å»º super_admin
- `@allow_super_admin_promotion` - å…è®¸æå‡ä¸º super_admin  
- `@allow_super_admin_demotion` - å…è®¸é™çº§ super_admin
- `@allow_super_admin_role_modification` - å…è®¸ä¿®æ”¹ super_admin è§’è‰²
- `@allow_super_admin_role_deletion` - å…è®¸åˆ é™¤ super_admin è§’è‰²

### 2. éªŒè¯æ•°æ®åº“é˜²æŠ¤

éªŒè¯é˜²æŠ¤æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```sql
-- æµ‹è¯•1ï¼šå°è¯•åˆ›å»ºsuper_adminç”¨æˆ·ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
INSERT INTO users (username, role) VALUES ('test_admin', 'super_admin');
-- é¢„æœŸé”™è¯¯ï¼šæ•°æ®åº“å®‰å…¨ç­–ç•¥ï¼šç¦æ­¢é€šè¿‡åº”ç”¨ç¨‹åºåˆ›å»ºè¶…çº§ç®¡ç†å‘˜ç”¨æˆ·

-- æµ‹è¯•2ï¼šå°è¯•æå‡ç°æœ‰ç”¨æˆ·ä¸ºsuper_adminï¼ˆåº”è¯¥å¤±è´¥ï¼‰
UPDATE users SET role = 'super_admin' WHERE id = 1;
-- é¢„æœŸé”™è¯¯ï¼šæ•°æ®åº“å®‰å…¨ç­–ç•¥ï¼šç¦æ­¢é€šè¿‡åº”ç”¨ç¨‹åºå°†ç”¨æˆ·æå‡ä¸ºè¶…çº§ç®¡ç†å‘˜

-- æµ‹è¯•3ï¼šå°è¯•ä½¿ç”¨æ— æ•ˆè§’è‰²ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
INSERT INTO users (username, role) VALUES ('test_user', 'invalid_role');
-- é¢„æœŸé”™è¯¯ï¼šCheck constraint violation

-- æµ‹è¯•4ï¼šå°è¯•ä¿®æ”¹super_adminè§’è‰²ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
UPDATE roles SET status = 0 WHERE code = 'super_admin';
-- é¢„æœŸé”™è¯¯ï¼šæ•°æ®åº“å®‰å…¨ç­–ç•¥ï¼šç¦æ­¢ç¦ç”¨è¶…çº§ç®¡ç†å‘˜è§’è‰²
```

### 3. ä»£ç å±‚é˜²æŠ¤ï¼ˆåŒé‡ä¿é™©ï¼‰

å·²åœ¨ `service/user.service.js` ä¸­æ·»åŠ ï¼š

```javascript
// ä¸å…è®¸å°†ç”¨æˆ·æå‡ä¸ºsuper_admin
if (role === 'super_admin') {
  throw new ApiError(httpStatus.FORBIDDEN, 'ä¸èƒ½å°†ç”¨æˆ·æå‡ä¸ºè¶…çº§ç®¡ç†å‘˜');
}

// å°†permissionså­—æ®µæ·»åŠ åˆ°å…è®¸ä¿®æ”¹çš„å­—æ®µç™½åå•
const ALLOWED_FIELDS = ['vip_expire', 'status', 'active', 'deleted', 'remark', 'birthday', 'permissions'];
```

### 4. ä¸­é—´ä»¶é˜²æŠ¤ï¼ˆå¯é€‰ï¼‰

å¯é€‰æ‹©åœ¨è·¯ç”±ä¸­ä½¿ç”¨è§’è‰²éªŒè¯ä¸­é—´ä»¶ï¼š

```javascript
const { validateRoleMiddleware } = require('../middleware/roleValidation');

// åœ¨ç”¨æˆ·åˆ›å»ºå’Œæ›´æ–°è·¯ç”±ä¸­ä½¿ç”¨
router.post('/create', auth(['admin', 'super_admin']), validateRoleMiddleware, validate(userValidation.createUser), userController.createUser);
router.post('/update', auth(['admin', 'super_admin']), validateRoleMiddleware, validate(userValidation.updateUser), userController.updateUser);
```

### 5. å®¡è®¡æ—¥å¿—é…ç½®ï¼ˆå¯é€‰ï¼‰

å¦‚éœ€å¯ç”¨å®¡è®¡æ—¥å¿—ï¼Œä¼šè‡ªåŠ¨è®°å½•åˆ°ï¼š
- `logs/security/security.log` - æ‰€æœ‰è§’è‰²å˜æ›´æ“ä½œ
- `logs/audit/audit.log` - æ•æ„Ÿè§’è‰²å˜æ›´æ“ä½œ

## ç³»ç»Ÿç®¡ç†å‘˜åˆæ³•æ“ä½œæŒ‡å—

### åˆ›å»ºæ–°çš„ Super Admin ç”¨æˆ·

```sql
-- 1. è®¾ç½®æˆæƒæ ‡è®°
SET @allow_super_admin_creation = 1;

-- 2. åˆ›å»ºsuper_adminç”¨æˆ·
INSERT INTO users (username, email, password, role, status, active) 
VALUES ('system_admin', 'admin@company.com', 'hashed_password', 'super_admin', 2, 1);

-- 3. æ¸…é™¤æˆæƒæ ‡è®°
SET @allow_super_admin_creation = NULL;
```

### å°†ç°æœ‰ç”¨æˆ·æå‡ä¸º Super Admin

```sql
-- 1. è®¾ç½®æˆæƒæ ‡è®°
SET @allow_super_admin_promotion = 1;

-- 2. æå‡ç”¨æˆ·
UPDATE users SET role = 'super_admin' WHERE id = 123;

-- 3. æ¸…é™¤æˆæƒæ ‡è®°
SET @allow_super_admin_promotion = NULL;
```

### é™çº§ Super Admin ç”¨æˆ·

```sql
-- 1. è®¾ç½®æˆæƒæ ‡è®°
SET @allow_super_admin_demotion = 1;

-- 2. é™çº§ç”¨æˆ·
UPDATE users SET role = 'admin' WHERE id = 123;

-- 3. æ¸…é™¤æˆæƒæ ‡è®°
SET @allow_super_admin_demotion = NULL;
```

### ä¿®æ”¹ Super Admin è§’è‰²å®šä¹‰

```sql
-- 1. è®¾ç½®æˆæƒæ ‡è®°
SET @allow_super_admin_role_modification = 1;

-- 2. ä¿®æ”¹è§’è‰²ä¿¡æ¯
UPDATE roles SET description = 'æ–°çš„æè¿°' WHERE code = 'super_admin';

-- 3. æ¸…é™¤æˆæƒæ ‡è®°
SET @allow_super_admin_role_modification = NULL;
```

## å®‰å…¨ç‰¹æ€§è¯¦è§£

### ğŸ›¡ï¸ é˜²æŠ¤å±‚çº§

1. **æ•°æ®åº“å±‚ï¼ˆæ ¸å¿ƒï¼‰** - CHECKçº¦æŸ + è§¦å‘å™¨ï¼Œæ— æ³•ç»•è¿‡çš„æœ€åé˜²çº¿
2. **ä»£ç å±‚ï¼ˆåŒé‡ä¿é™©ï¼‰** - ä¸šåŠ¡é€»è¾‘éªŒè¯ï¼ŒAPIçº§åˆ«é˜»æ­¢
3. **ä¸­é—´ä»¶å±‚ï¼ˆå¯é€‰ï¼‰** - ç»Ÿä¸€çš„è§’è‰²éªŒè¯ä¸­é—´ä»¶
4. **å®¡è®¡å±‚ï¼ˆå¯é€‰ï¼‰** - å®Œæ•´æ“ä½œè®°å½•å’Œç›‘æ§

### ğŸ” æ•°æ®åº“å±‚é˜²æŠ¤æœºåˆ¶

#### Usersè¡¨è§¦å‘å™¨ä¿æŠ¤ï¼š
- âœ… é˜»æ­¢åˆ›å»º super_admin ç”¨æˆ·
- âœ… é˜»æ­¢æå‡ç”¨æˆ·ä¸º super_admin  
- âœ… é˜»æ­¢é™çº§ super_admin ç”¨æˆ·
- âœ… CHECKçº¦æŸé™åˆ¶è§’è‰²å€¼èŒƒå›´

#### Rolesè¡¨è§¦å‘å™¨ä¿æŠ¤ï¼š
- âœ… é˜»æ­¢ä¿®æ”¹ super_admin è§’è‰²ç¼–ç 
- âœ… é˜»æ­¢ç¦ç”¨ super_admin è§’è‰²
- âœ… é˜»æ­¢åˆ é™¤ super_admin è§’è‰²å®šä¹‰
- âœ… é˜»æ­¢è½¯åˆ é™¤ super_admin è§’è‰²

### ğŸ“‹ è§’è‰²ç®¡ç†æƒé™çŸ©é˜µ

| å½“å‰è§’è‰² | å¯ä»¥ç®¡ç†çš„è§’è‰² | è¢«æ•°æ®åº“ä¿æŠ¤çš„æ“ä½œ |
|---------|-------------|------------------|
| super_admin | guest, user, operator, admin | æ— æ³•åˆ›å»º/æå‡å…¶ä»– super_admin |
| admin | guest, user, operator | æ— æ³•æå‡ä¸º super_admin |
| operator | guest, user | æ— æ³•æå‡ä¸º admin/super_admin |
| **æ•°æ®åº“å±‚** | **æ‰€æœ‰æ“ä½œ** | **å®Œå…¨é˜»æ­¢ super_admin ç›¸å…³æ“ä½œ** |

### å®‰å…¨æ—¥å¿—ç¤ºä¾‹

```json
{
  "event": "ROLE_CHANGE",
  "operation": "UPDATE", 
  "targetUserId": 82,
  "oldRole": "user",
  "newRole": "super_admin",
  "operatorId": 78,
  "operatorRole": "super_admin",
  "operatorUsername": "admin",
  "ip": "192.168.1.100",
  "timestamp": "2025-09-18T03:13:25.000Z"
}
```

## ç›‘æ§å’Œå‘Šè­¦

å»ºè®®è®¾ç½®ä»¥ä¸‹ç›‘æ§ï¼š

1. **å¤±è´¥å°è¯•ç›‘æ§** - ç›‘æ§ 403 é”™è¯¯å’Œè§’è‰²æå‡å¤±è´¥
2. **æ•°æ®åº“è§¦å‘å™¨å‘Šè­¦** - ç›‘æ§è§¦å‘å™¨è§¦å‘çš„é”™è¯¯
3. **å®¡è®¡æ—¥å¿—åˆ†æ** - å®šæœŸæ£€æŸ¥æ•æ„Ÿæ“ä½œ

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ•°æ®åº“å±‚é˜²æŠ¤æµ‹è¯•

ç›´æ¥åœ¨æ•°æ®åº“ä¸­æµ‹è¯•é˜²æŠ¤æœºåˆ¶ï¼š

```sql
-- æµ‹è¯•1ï¼šéªŒè¯CHECKçº¦æŸ
INSERT INTO users (username, role) VALUES ('test', 'invalid_role');
-- é¢„æœŸï¼šCheck constraint violation

-- æµ‹è¯•2ï¼šéªŒè¯INSERTè§¦å‘å™¨  
INSERT INTO users (username, role) VALUES ('test_admin', 'super_admin');
-- é¢„æœŸï¼šæ•°æ®åº“å®‰å…¨ç­–ç•¥ï¼šç¦æ­¢é€šè¿‡åº”ç”¨ç¨‹åºåˆ›å»ºè¶…çº§ç®¡ç†å‘˜ç”¨æˆ·

-- æµ‹è¯•3ï¼šéªŒè¯UPDATEè§¦å‘å™¨
UPDATE users SET role = 'super_admin' WHERE id = 1;
-- é¢„æœŸï¼šæ•°æ®åº“å®‰å…¨ç­–ç•¥ï¼šç¦æ­¢é€šè¿‡åº”ç”¨ç¨‹åºå°†ç”¨æˆ·æå‡ä¸ºè¶…çº§ç®¡ç†å‘˜

-- æµ‹è¯•4ï¼šéªŒè¯è§’è‰²è¡¨ä¿æŠ¤
UPDATE roles SET status = 0 WHERE code = 'super_admin';  
-- é¢„æœŸï¼šæ•°æ®åº“å®‰å…¨ç­–ç•¥ï¼šç¦æ­¢ç¦ç”¨è¶…çº§ç®¡ç†å‘˜è§’è‰²
```

### APIå±‚é˜²æŠ¤æµ‹è¯•

è¿è¡Œåº”ç”¨ç¨‹åºå®‰å…¨æµ‹è¯•ï¼š

```bash
# è¿è¡Œå®Œæ•´çš„å®‰å…¨æµ‹è¯•å¥—ä»¶
node test/test_api_security_single.js

# åº”è¯¥çœ‹åˆ°ä»¥ä¸‹é˜²æŠ¤ç”Ÿæ•ˆï¼š
# - super_adminæå‡è¯·æ±‚è¢«æ‹’ç»ï¼ˆ403é”™è¯¯ï¼‰
# - adminç”¨æˆ·åˆ—è¡¨ä¸åŒ…å«super_adminç”¨æˆ·
# - æƒé™éš”ç¦»æ­£å¸¸å·¥ä½œ
```

## ç»´æŠ¤å»ºè®®

1. **å®šæœŸå®¡æŸ¥** - æ¯æœˆæ£€æŸ¥å®¡è®¡æ—¥å¿—
2. **æƒé™æœ€å°åŒ–** - ä¸¥æ ¼æ§åˆ¶ super_admin æ•°é‡
3. **å®šæœŸæµ‹è¯•** - è¿è¡Œå®‰å…¨æµ‹è¯•ç¡®ä¿é˜²æŠ¤æœ‰æ•ˆ
4. **æ–‡æ¡£æ›´æ–°** - å½“æ·»åŠ æ–°çš„ç”¨æˆ·ç®¡ç†æ¥å£æ—¶ï¼Œç¡®ä¿åº”ç”¨ç›¸åŒçš„å®‰å…¨æªæ–½

## åº”æ€¥å“åº”

å¦‚å‘ç°éæ³•çš„ super_admin æå‡ï¼š

1. ç«‹å³æ£€æŸ¥å®¡è®¡æ—¥å¿—ç¡®å®šæ¥æº
2. é™çº§å—å½±å“çš„ç”¨æˆ·æƒé™
3. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å®‰å…¨æ¼æ´
4. æ›´æ–°å®‰å…¨æªæ–½

## ğŸ“ æ€»ç»“

### ğŸ› ï¸ å®ç°çš„é˜²æŠ¤æœºåˆ¶

è¿™å¥—å¤šå±‚é˜²æŠ¤æœºåˆ¶åŒ…å«ï¼š

1. **ğŸ›¡ï¸ æ•°æ®åº“å±‚æ ¸å¿ƒé˜²æŠ¤**
   - CHECKçº¦æŸç¡®ä¿è§’è‰²å€¼æœ‰æ•ˆæ€§
   - è§¦å‘å™¨é˜»æ­¢æ‰€æœ‰éæˆæƒçš„super_adminæ“ä½œ
   - å³ä½¿åº”ç”¨ä»£ç è¢«å®Œå…¨ç»•è¿‡ï¼Œæ•°æ®åº“å±‚é¢ä»èƒ½æä¾›ä¿æŠ¤

2. **ğŸ”’ ä»£ç å±‚åŒé‡ä¿é™©**
   - ä¸šåŠ¡é€»è¾‘å±‚é¢çš„éªŒè¯å’Œé˜»æ­¢
   - APIæ¥å£çº§åˆ«çš„æƒé™æ§åˆ¶
   - ä¸ºå¸¸è§æ“ä½œæä¾›å¿«é€Ÿåé¦ˆ

3. **ğŸ¯ æƒé™éš”ç¦»æœºåˆ¶**
   - adminç”¨æˆ·æŸ¥è¯¢æ—¶è‡ªåŠ¨æ’é™¤super_admin
   - ä¸åŒè§’è‰²å…·æœ‰æ˜ç¡®çš„ç®¡ç†æƒé™è¾¹ç•Œ
   - é˜²æ­¢æƒé™è¶Šç•Œå’Œä¿¡æ¯æ³„éœ²

### ğŸ”§ æŠ€æœ¯å®ç°ç‰¹ç‚¹

- **æ•°æ®åº“ç¡¬çº¦æŸ**ï¼šä»»ä½•å½¢å¼çš„æ“ä½œéƒ½ä¼šè¢«æ‹¦æˆª
- **å‘å‰å…¼å®¹ä¿æŠ¤**ï¼šæœªæ¥æ–°å¢çš„ä»£ç æˆ–æ¥å£éƒ½å—åˆ°åŒæ ·ä¿æŠ¤
- **æ­£å¸¸ä¸šåŠ¡ä¸å—å½±å“**ï¼šç”¨æˆ·ç®¡ç†æ“ä½œæ­£å¸¸è¿›è¡Œ
- **æˆæƒå˜é‡æ§åˆ¶**ï¼šåªæœ‰æ•°æ®åº“ç®¡ç†å‘˜æ‰èƒ½é€šè¿‡æˆæƒå˜é‡è¿›è¡Œsuper_adminæ“ä½œ

### ğŸ” å®‰å…¨ä¿è¯

å³ä½¿åœ¨ä»¥ä¸‹æç«¯æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä»ç„¶å®‰å…¨ï¼š
- åº”ç”¨ä»£ç è¢«æ¶æ„ä¿®æ”¹
- æ–°å¼€å‘äººå‘˜ä¸äº†è§£å®‰å…¨è§„åˆ™
- ORMæˆ–æ•°æ®è®¿é—®å±‚è¢«ç»•è¿‡
- ç›´æ¥çš„SQLæ³¨å…¥æ”»å‡»

**æ•°æ®åº“è§¦å‘å™¨ä½œä¸ºæœ€åä¸€é“é˜²çº¿ï¼Œç¡®ä¿super_adminè§’è‰²çš„ç»å¯¹å®‰å…¨ï¼**