name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      platforms:
        description: '要构建的平台 (逗号分隔: mac-x64,mac-arm64,mac-universal,win-x64,win-arm64，或 all)'
        required: false
        default: 'all'

env:
  NODE_VERSION: '18'

jobs:
  build-macos:
    name: Build macOS ${{ matrix.arch }}
    runs-on: macos-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platforms == 'all' || 
        contains(github.event.inputs.platforms, format('mac-{0}', matrix.arch))))

    strategy:
      matrix:
        include:
          - arch: x64
            suffix: mac-intel-x64
            electron_arch: x64
          - arch: arm64
            suffix: mac-apple-arm64
            electron_arch: arm64
          - arch: universal
            suffix: mac-universal
            electron_arch: universal

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装 pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: 安装根目录依赖
        run: pnpm install --frozen-lockfile

      - name: 构建 macOS ${{ matrix.arch }}
        run: npx electron-builder --mac --${{ matrix.electron_arch }}
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: 重命名 DMG
        run: |
          VERSION=$(node -p "require('./package.json').version")
          OUTPUT_DIR="dist"
          for file in "$OUTPUT_DIR"/*.dmg; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              mv "$file" "$OUTPUT_DIR/ppll-client-v${VERSION}-${{ matrix.suffix }}.dmg"
            fi
          done

      - name: 显示构建产物
        run: ls -lh dist/

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ppll-client-${{ matrix.suffix }}
          path: dist/*.dmg
          retention-days: 30

  build-windows:
    name: Build Windows ${{ matrix.arch }}
    runs-on: windows-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platforms == 'all' || 
        contains(github.event.inputs.platforms, format('win-{0}', matrix.arch))))

    strategy:
      matrix:
        include:
          - arch: x64
            suffix: win-x64
            electron_arch: x64
          - arch: arm64
            suffix: win-arm64
            electron_arch: arm64

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装 pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: 安装根目录依赖
        run: pnpm install --frozen-lockfile

      - name: 构建 Windows ${{ matrix.arch }}
        run: npx electron-builder --win --${{ matrix.electron_arch }}
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: 重命名安装程序
        shell: pwsh
        run: |
          $VERSION = node -p "require('./package.json').version"
          $OUTPUT_DIR = "dist"
          Get-ChildItem -Path "$OUTPUT_DIR\*.exe" | ForEach-Object {
            $newName = "ppll-client-v$VERSION-${{ matrix.suffix }}-installer.exe"
            Move-Item -Path $_.FullName -Destination "$OUTPUT_DIR\$newName" -Force
          }

      - name: 显示构建产物
        shell: pwsh
        run: Get-ChildItem -Path dist -Filter *.exe | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB, 2)}}

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ppll-client-${{ matrix.suffix }}
          path: dist/*-installer.exe
          retention-days: 30
          if-no-files-found: warn

  create-release:
    name: 创建发布
    needs: [build-macos, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: 显示文件列表
        run: |
          echo "下载的文件："
          find artifacts -type f -exec ls -lh {} \;

      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
