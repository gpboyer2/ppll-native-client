name: Build Multi-Platform

# 触发条件
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # 允许手动触发

# 构建矩阵
env:
  GO_VERSION: '1.21'
  NODE_VERSION: '22'

jobs:
  build-macos:
    name: Build macOS ${{ matrix.target }}
    runs-on: macos-latest

    strategy:
      matrix:
        include:
          - target: amd64
            platform: darwin/amd64
            suffix: mac-intel-x64
          - target: arm64
            platform: darwin/arm64
            suffix: mac-apple-arm64
          - target: universal
            platform: darwin/universal
            suffix: mac-universal

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 安装 pnpm
        run: npm install -g pnpm

      - name: 安装 Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: 安装 Go 依赖
        run: go mod tidy

      - name: 安装前端依赖
        run: |
          cd frontend
          pnpm install --no-frozen-lockfile || pnpm install

      - name: 安装 Node.js 后端依赖
        run: |
          cd nodejs-server
          pnpm install --no-frozen-lockfile || pnpm install
          # 编译 sqlite3
          pnpm rebuild sqlite3 || echo "sqlite3 rebuild skipped"

      - name: 下载 Node.js 可执行文件
        run: |
          ./scripts/download-nodejs.sh ${{ matrix.platform }}

      - name: 构建 macOS ${{ matrix.target }}
        run: |
          wails build -platform ${{ matrix.platform }} -clean

      - name: 嵌入 Node.js 到 .app
        run: |
          NODE_SRC="build/node-bin/node"
          APP_PATH="build/bin/ppll-native-client.app"
          RESOURCES_DIR="$APP_PATH/Contents/Resources"

          if [ -f "$NODE_SRC" ] && [ -d "$APP_PATH" ]; then
            mkdir -p "$RESOURCES_DIR"
            cp -f "$NODE_SRC" "$RESOURCES_DIR/node"
            chmod +x "$RESOURCES_DIR/node"
            echo "✓ Node.js 已嵌入到: $RESOURCES_DIR/node"
          fi

      - name: 复制 nodejs-server 到 .app
        run: |
          APP_PATH="build/bin/ppll-native-client.app"
          RESOURCES_DIR="$APP_PATH/Contents/Resources"

          if [ -d "nodejs-server" ] && [ -d "$APP_PATH" ]; then
            mkdir -p "$RESOURCES_DIR"
            cp -R nodejs-server "$RESOURCES_DIR/"
            echo "✓ nodejs-server 已复制到: $RESOURCES_DIR/nodejs-server"
          fi

      - name: 创建 DMG
        run: |
          VERSION=$(grep '"productVersion"' wails.json | sed 's/.*"productVersion": "\(.*\)".*/\1/')
          OUTPUT_FILE="build/ppll-client-v${VERSION}-${{ matrix.suffix }}.dmg"

          mkdir -p build/temp_dmg
          cp -R build/bin/ppll-native-client.app build/temp_dmg/

          hdiutil create -volname "PPLL Client" \
            -srcfolder build/temp_dmg \
            -ov -format UDZO "$OUTPUT_FILE"

          rm -rf build/temp_dmg
          ls -lh "$OUTPUT_FILE"

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ppll-client-${{ matrix.suffix }}
          path: build/*.dmg
          retention-days: 30

  build-windows:
    name: Build Windows ${{ matrix.target }}
    runs-on: windows-latest

    strategy:
      matrix:
        include:
          - target: amd64
            platform: windows/amd64
            suffix: win-x64
          - target: arm64
            platform: windows/arm64
            suffix: win-arm64

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 安装 pnpm
        run: npm install -g pnpm

      - name: 安装 Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: 安装 Go 依赖
        run: go mod tidy

      - name: 安装前端依赖
        run: |
          cd frontend
          pnpm install --no-frozen-lockfile || pnpm install

      - name: 安装 Node.js 后端依赖
        run: |
          cd nodejs-server
          pnpm install --no-frozen-lockfile || pnpm install
          # Windows 下编译 sqlite3
          pnpm rebuild sqlite3 || echo "sqlite3 rebuild skipped"

      - name: 下载 Node.js 可执行文件
        run: ./scripts/download-nodejs.sh ${{ matrix.platform }}

      - name: 构建 Windows ${{ matrix.target }}
        run: wails build -platform ${{ matrix.platform }} -clean

      - name: 嵌入 Node.js 到构建目录
        shell: pwsh
        run: |
          $NODE_SRC = "build/node-bin/node.exe"
          $BUILD_DIR = "build/bin"

          if (Test-Path $NODE_SRC) {
            Copy-Item -Path $NODE_SRC -Destination "$BUILD_DIR/node.exe" -Force
            Write-Host "✓ Node.js 已复制到: $BUILD_DIR/node.exe"
          }

      - name: 复制 nodejs-server 到构建目录
        shell: pwsh
        run: |
          $BUILD_DIR = "build/bin"

          if (Test-Path "nodejs-server") {
            Copy-Item -Path "nodejs-server" -Destination "$BUILD_DIR/nodejs-server" -Recurse -Force
            Write-Host "✓ nodejs-server 已复制到: $BUILD_DIR/nodejs-server"
          }

      - name: 生成 NSIS 安装程序
        run: wails build -platform ${{ matrix.platform }} -nsis

      - name: 准备 NSIS 安装程序输出
        shell: pwsh
        run: |
          $VERSION = (Get-Content wails.json | Select-String '"productVersion"' | ForEach-Object { $_.ToString() -replace '.*"productVersion": "(.*)".*', '$1' })
          $INSTALLER_EXE = "build/bin/ppll-native-client-install.exe"
          $OUTPUT_FILE = "build/ppll-client-v$VERSION-${{ matrix.suffix }}-installer.exe"

          if (Test-Path $INSTALLER_EXE) {
            Move-Item -Path $INSTALLER_EXE -Destination $OUTPUT_FILE -Force
            Write-Host "✓ NSIS 安装程序已重命名: $OUTPUT_FILE"
            Get-Item $OUTPUT_FILE | Select-Object Name, @{Name="Size";Expression={$_.Length/1MB}}
          } else {
            Write-Host "警告: 未找到 NSIS 安装程序，可能需要安装 NSIS"
          }

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ppll-client-${{ matrix.suffix }}
          path: build/*-installer.exe
          retention-days: 30
          if-no-files-found: warn

  create-release:
    name: 创建发布
    needs: [build-macos, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: 显示文件列表
        run: |
          echo "下载的文件："
          find artifacts -type f -exec ls -lh {} \;

      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
